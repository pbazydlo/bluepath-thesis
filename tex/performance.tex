
\chapter{Testy jakociowe i wydajnociowe}

W bibliotekach wykorzystywanych przez programist贸w r贸wnie wa偶na jak
bogata funkcjonalno czy atwo u偶ycia jest stabilno dziaania
i pewno, 偶e bd w~wykonaniu aplikacji nie le偶y po stronie biblioteki.
W zwizku z tym istotne jest pokrycie kodu biblioteki zestawem test贸w
zar贸wno jednostkowych jak i akceptacyjnych, kt贸re zostay opisane
w niniejszym rozdziale.

Opr贸cz test贸w jakociowych przeprowadzone zostay testy wydajnociowe,
kt贸re pozwoliy okreli wydajno biblioteki w obecnym stanie implementacyjnym
oraz okreli wpyw rodzaju przetwarzania na zasadno prowadzenia
przetwarzania rozproszonego.


\section{Testy jakociowe}

\label{sec:Testy-jako=00015Bciowe}Testy jakociowe pozwalaj na sprawdzenie
konkretnych funkcji biblioteki w spreparowanym rodowisku testowym.
Testy jednostkowe i integracyjne, dziaaj w rodowisku Microsoft
Unit Test Framework \cite{Microsoft-Unit-Test-Framework-for-Managed-Code}
zintegrowanym ze rodowiskiem Visual Studio. Dodatkowo wykorzystana
zostaa biblioteka Shoudly \cite{Shouldly} do zapisu asercji oraz
Moq \cite{Moq} do tworzenia atrap obiekt贸w.


\subsection{Testy jednostkowe}

Testujc niekt贸re funkcje biblioteki wskazane byo sprawdzenie ich
zachowania abstrahujc od ich zale偶noci. W tym celu r贸wnolegle z
tworzonym kodem powstaway testy jednostkowe. Nale偶y r贸wnie偶 zwr贸ci
uwag, 偶e testy jednostkowe wykonuj si znacznie szybciej od test贸w
integracyjnych, co pozwala znaczco skr贸ci czas wykrycia oraz poprawy
ewentualnych bd贸w. Poni偶ej przedstawiono przykadowe przypadki testowe:
\begin{itemize}
\item \dcsname{lokalny wykonawca} -- operacja \dcscode{Join} z okrelonym
limitem czasu oczekiwania na jej zakoczenie,
\item \dcsname{zdalny wykonawca} -- testy operacji \dcscode{Pulse} z u偶yciem
atrapy obiektu (ang.~\dcsemph{mock object}),
\item usuga \dcsname{zdalnego wykonawcy} -- wykonanie metody z u偶yciem
zserializowanego uchwytu, przechwytywanie wyjtk贸w w kodzie u偶ytkownika,
zwracanie statystyk obci偶enia wza oraz testy z u偶yciem zmienionej
implementacji interfejsu (ang.~\dcsemph{fake object}) -- operacji
\dcscode{Join} (synchronicznej i asynchronicznej), rzucenia przechwyconego
w kodzie u偶ytkownika wyjtku w momencie wykonywania operacji \dcscode{Join},
wstrzykiwania zale偶noci \dcscode{IBluepathCommunicationFramework}
(przez podmian oraz przez dodanie brakujcego parametru),
\item \dcsname{wtek rozproszony} -- wykonanie z u偶yciem \dcsname{lokalnego wykonawcy},
\dcsname{zdalnego wykonawcy} (potrzebne usugi, tj. \dcscode{IRemoteExecutorService}
i \dcscode{IScheduler} zostay zasymulowane za pomoc atrap obiekt贸w,
u偶yto te偶 \dcsname{zarzdcy pocze} w trybie bez wywoa zwrotnych),
gbokie kopiowanie parametr贸w wywoania,
\item planista \dcscode{ThreadNumberScheduler} -- test sprawdza, czy nastpuje
wyb贸r najmniej obci偶onego wza spor贸d zasymulowanych,
\item z uwagi na u偶ycie wasnej klasy \dcscode{ServiceUri} jako klucza
w sowniku, testowano te偶 taki scenariusz.
\end{itemize}

\subsection{Testy integracyjne}

W celu przetestowania dziaania funkcji takich jak przesyanie klas
jako parametr贸w wskazane jest stworzenie test贸w integracyjnych. Ich
zadaniem jest przetestowanie nie tylko logiki wykonywanego kodu, ale
r贸wnie偶 wykrycie problem贸w jakie mog si pojawi w zwizku z dziaaniem
w rodowisku sieciowym (np. wymagane uprawnienia do utworzenia usugi
nasuchujcej, serializacja obiekt贸w).

Jednym z problem贸w zwizanych z testami integracyjnymi jest potrzeba
stworzenia rodowiska testowego. W momencie gdy zachodzi potrzeba
uruchomienia zewntrznego programu (np. Redisa) system operacyjny
nie dostarcza narzdzi, kt贸re pozwoliyby okreli nie tylko czy dany
proces jest ju偶 uruchomiony, ale r贸wnie偶 czy skoczy on proces inicjalizacji.
Nale偶y r贸wnie偶 zwr贸ci uwag, 偶e testy nie powinny by od siebie zale偶ne
-- a wic efekt wykonania jednego testu nie powinien mie wpywu na
inne testy. Aby tego unikn, ka偶dy test zosta wyposa偶ony w taki
zestaw parametr贸w, kt贸ry pozwoli mu si wykona niezale偶nie od innych
(np. port na kt贸rym ma nasuchiwa usuga \dcsname{Bluepath}).

W ramach test贸w integracyjnych przetestowane zostay nastpujce aspekty:
\begin{itemize}
\item \dcsname{wtki rozproszone} -- zachowanie systemu w wyniku pr贸by
wykonania metod akceptujcych r贸偶ne typy parametr贸w i zwracajce wyniki
r贸偶nego typu -- tablice, klasy (tak偶e generyczne), delegaty, a tak偶e
obsuga wyjtk贸w w kodzie u偶ytkownika oraz w przypadku nieprawidowego
wywoania; test obejmowa tak偶e wykonanie metody z biblioteki napisanej
w jzyku F\#,
\item \dcsname{zarzdca pocze} -- pobieranie listy dostpnych wz贸w
z \dcsname{usugi odnajdywania wz贸w} i aktualizowanie swojej
lokalnej kopii listy (dodawanie nowych wz贸w i usuwanie wyrejestrowanych),
pobieranie informacji o obci偶eniu wz贸w zarejestrowanych w klastrze,
\item \dcsname{pami rozproszona} -- testy zapisu i odczytu obiekt贸w
(tak偶e jako operacji zbiorczych),
\item \dcsname{zamki rozproszone} -- pobieranie i zwalnianie zamk贸w (tak偶e
z limitem czasu), budzenie wtk贸w czekajcych na zamkach,
\item a tak偶e testy struktur danych i obiekt贸w zbudowanych na bazie \dcsname{pamici rozproszonej}
-- lista, sownik, licznik.
\end{itemize}

\section{Testy wydajnociowe}

Wa偶n czci tworzenia biblioteki programistycznej jest zweryfikowanie
jej zachowania w przykadowych zastosowaniach. Pozwala to zweryfikowa
suszno przyjtych zao偶e i rozwiza. 

Przy okazji weryfikacji dziaania biblioteki \dcsname{Bluepath} przeprowadzone
zostay testy wydajnociowe, zestawiajce efekt wykonania przetwarzania
w klastrze w stosunku do przetwarzania na pojedynczym procesorze oraz
por贸wnanie dostarczonych przykadowych algorytm贸w szeregowania zada.


\subsection{rodowisko }

rodowisko do przeprowadzenia test贸w wydajnociowych zostao przygotowane
w~oparciu o platform Microsoft Azure \cite{Microsoft-Azure}. Klaster
skada si z 7 maszyn wirtualnych -- na szeciu z nich dziaay usugi
systemu Bluepath pod kontrol systemu operacyjnego Windows Server
2012 R2 Datacenter (wydanego 17 czerwca 2014 r.), a na jednej maszynie
uruchomiony zosta host \dcsname{pamici rozproszonej} Redis pod
kontrol systemu operacyjnego Ubuntu Server 14.04 LTS (wydanego 20
czerwca 2014 r.). Maszyny r贸偶niy si konfiguracj sprztow w zale偶noci
od przeznaczenia:
\begin{itemize}
\item wze inicjujcy przetwarzanie by typu \dcsname{Medium VM (Basic A2)}
i posiada 2~wirtualne rdzenie AMD Operton 1,6 GHz i 3,5 GB pamici
operacyjnej, 
\item wzy obliczeniowe byy typu \dcsname{Small VM (Basic A1)} dysponoway
po 1 wirtualnym rdzeniu AMD Opteron 1,6 GHz i 1,75 GB pamici operacyjnej, 
\item wze hostujcy usug Redis bya to instancja typu \dcsname{Large VM (Basic A3)}
posiadajca cztery rdzenie AMD Opteron 1,6 GHZ i 7 GB pamici operacyjnej. 
\end{itemize}
Szczeg贸y konfiguracji zestawiono w tabeli \ref{tab:performance-Konfiguracja-testowego-klastra}.
Maszyny wirtualne wchodzce w~skad klastra poczone zostay w wirtualn
sie, w kt贸rej wyczone byy zapory sieciowe, a komunikacja odbywaa
si z u偶yciem prywatnych wewntrznych adres贸w IP (tzw. \dcsname{DIP},
przydzielony automatycznie przez Windows Azure z u偶yciem DHCP). 

\begin{table}
\centering{}\protect\caption{\label{tab:performance-Konfiguracja-testowego-klastra}Konfiguracja
testowego klastra}
\begin{tabular}{|c|c|c|c|c|}
\hline 
Nazwa maszyny & Typ instancji & Liczba rdzeni & Pami RAM & System operacyjny\tabularnewline
\hline 
\hline 
Master & A2 & 2 & 3,5 GB & Windows Server\tabularnewline
\hline 
Slave1 & A1 & 1 & 1,75 GB & Windows Server\tabularnewline
\hline 
Slave2 & A1 & 1 & 1,75 GB & Windows Server\tabularnewline
\hline 
Slave3 & A1 & 1 & 1,75 GB & Windows Server\tabularnewline
\hline 
Slave4 & A1 & 1 & 1,75 GB & Windows Server\tabularnewline
\hline 
Slave5 & A1 & 1 & 1,75 GB & Windows Server\tabularnewline
\hline 
Redis & A3 & 4 & 7 GB & Ubuntu Server\tabularnewline
\hline 
\end{tabular}
\end{table}


Do dystrybucji nowych wersji bibliotek systemu Bluepath na wszystkie
maszyny w klastrze przygotowany zosta skrypt PowerShell przedstawiony
na listingu \ref{lis:performance-Skrypt-dystrybuuj=000105cy-biblioteki}.
Wykorzystuje on opisany w punkcie \ref{sec:implementation-Skrypt-Send-Folder}
skrypt \dcspath{Send-Folder}.

\inputencoding{latin2}\begin{lstlisting}[caption={Skrypt
dystrybuujcy biblioteki w klastrze},label={lis:performance-Skrypt-dystrybuuj=000105cy-biblioteki},breaklines=true,language=bash,numbers=left]
.\Send-Folder.ps1 -server [adres wza 1] -user [nazwa uytkownika] 
  -password [haso] -source [folder rdowy] -destination [folder docelowy]
...
.\Send-Folder.ps1 -server [adres wza n] -user [nazwa uytkownika] 
  -password [haso] -source [folder rdowy] -destination [folder docelowy]
\end{lstlisting}
\inputencoding{utf8}


\subsection{Generowanie sownika prefiks贸w}

Jednym z algorytm贸w wykorzystanych do pomiaru wydajnoci by algorytm
tworzcy prefiksy na potrzeby przeprowadzenia operacji uzupeniania
tekstu opisany w~punkcie \ref{sub:zastosowania-autocomplete-Wczytywanie-danych}.
Dla okrelonej liczby dokument贸w znajdujcych si w \dcsname{pamici rozproszonej}
pomiar czasu przetwarzania by powtarzany dziesi razy. Wykres \ref{fig:performance-Generowanie-prefixow}
przedstawia por贸wnanie urednionych czas贸w generowania sownika prefiks贸w
na pojedynczym w藕le oraz w klastrze. Dla zbioru 10000 dokument贸w
udao si uzyska prawie dwukrotne przyspieszenie w stosunku do przetwarzania
na pojedynczej maszynie. Warto r贸wnie偶 nadmieni, 偶e w algorytmie
testujcym wprowadzono mechanizm okresowo czyszczcy lokaln pami
prefiks贸w ze wzgldu na wyczerpywanie si pamici w przypadku przetwarzania
na pojedynczym w藕le.

\begin{figure}
\centering{}\includegraphics[scale=0.5]{images/prefixy-6}\protect\caption{\label{fig:performance-Generowanie-prefixow}Por贸wnanie czasu generowania
sownika prefiks贸w }
\end{figure}



\subsection{Obliczanie przybli偶enia liczby $\pi$}

\label{sub:performance-Obliczanie-przyblizenia-Pi}Kolejnym algorytmem,
przy pomocy kt贸rego zmierzono zysk zwizany z zastosowaniem biblioteki
Bluepath byo obliczanie przybli偶enia liczby $\pi$ metod przedstawion
w punkcie \ref{sec:Przykladowe-zastosowania-liczba-pi}. Wykres \ref{fig:performace-Por=0000F3wnanie-czasu-obliczania-pi}
przedstawia por贸wnanie urednionych czas贸w przetwarzania na pojedynczym
w藕le oraz w klastrze w zale偶noci od rozmiaru instancji. Czas zosta
przedstawiony w skali logarytmicznej. 

\begin{figure}
\centering{}\includegraphics[scale=0.5]{images/pi-5-machines}\protect\caption{\label{fig:performace-Por=0000F3wnanie-czasu-obliczania-pi}Por贸wnanie
czasu obliczania przybli偶enia liczby $\pi$}
\end{figure}


Dla du偶ych instancji przetwarzanie przy pomocy biblioteki Bluepath
jest du偶o szybsze ni偶 przetwarzanie na pojedynczym w藕le. Jednak dla
maych instancji narzut generowany przez bibliotek sprawia, 偶e przetwarzanie
w klastrze staje si mniej efektywne ni偶 przetwarzanie lokalne. Mo偶na
to r贸wnie偶 zauwa偶y na wykresie \ref{fig:performace-Przyspieszenie-pi}.
Przedstawia on przyspieszenie uzyskane w zwizku z zastosowaniem biblioteki
Bluepath do przetwarzania w klastrze w stosunku do przetwarzania na
pojedynczym w藕le. 

\begin{figure}
\centering{}\includegraphics[scale=0.5]{images/pi-5-speedup}\protect\caption{\label{fig:performace-Przyspieszenie-pi}Przyspieszenie w stosunku
do przetwarzania lokalnego}
\end{figure}


Narzut widoczny na obu wykresach jest czstym zjawiskiem w systemach
rozproszonych i wynika z koniecznoci przeprowadzenia komunikacji
sieciowej.
